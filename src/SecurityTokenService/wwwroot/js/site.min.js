function initError(){const n=parseInt(getQueryParam("errorId"));printError(n)}function printError(n){switch(n){case 4001:$("#message").text("不支持双因素认证");break;case 4002:$("#message").text("用户被禁止登录");break;case 4003:$("#message").text("用户被锁定");break;case 4004:$("#message").text("用户名或密码不正确");break;case 4005:$("#message").text("不支持 NativeClient");break;case 4006:$("#message").text("返回地址不合法");break;case 4007:$("#message").text("选择的操作不正确");break;case 4008:$("#message").text("没有 Scope 可匹配");break;case 4009:$("#message").text("客户端标识出错");break;case 4010:$("#message").text("授权请求链接不正确");break;case 4011:$("#message").text("登录失败");break;default:$("#message").text("未知错误")}}function initRedirect(){const n=getQueryParam("redirectUrl");n&&(window.location.href=n)}function initConsent(){const n=getQueryParam("returnUrl");$.ajax({xhrFields:{withCredentials:!0},type:"GET",url:"consent?returnUrl="+n,success:function(n){const t=n.data;if($("#clientName").prepend(t.clientName),t.clientLogoUrl?$("#clientLogoUrl").attr("src",t.clientLogoUrl):$("#clientLogoUrl").remove(),$("#returnUrl").val(t.returnUrl),t.identityScopes&&t.identityScopes.length>0){for(let n=0;n<t.identityScopes.length;++n){const i=t.identityScopes[n];appendScope("identityScopeList",i)}$("#identityScopes").show()}if(t.resourceScopes&&t.resourceScopes.length>0){for(let n=0;n<t.resourceScopes.length;++n){const i=t.resourceScopes[n];appendScope("resourceScopes",i)}$("#resourceScopes").show()}t.allowRememberConsent?$("#rememberConsentDiv").show():$("#rememberConsent").val(!1);t.clientUrl&&($("#client").attr("href",t.clientUrl),$("#clientName2").text(t.clientName))},error:function(){}})}function appendScope(n,t){const i=`<li class="list-group-item">
<label>
 <input class="consent-scopecheck" type="checkbox"
    name="ScopesConsented"
    id="scopes_${t.name}"
    value="${t.name}"
    ${t.checked?'checked="checked"':""}
    ${t.required?'disabled="disabled"':""} />
    <strong>${t.displayName}</strong>
    ${t.required?'<input type="hidden" name="ScopesConsented" value="'+t.name+'"/>':""}
</label>
${scope.required ? '<span><em>(required)</em></span>' : ''}
${scope.description ? '<div class="consent-description"><label for="scopes_' + scope.name + '">' + scope.description + '</label></div>' : ''}
</li>`;$("#"+n).append(i)}function initDiagnostics(){$.ajax({xhrFields:{withCredentials:!0},type:"GET",url:"diagnostics",success:function(n){if(n.claims&&n.claims.length>0){const t=$("#claims");for(let i=0;i<n.claims.length;++i){const r=n.claims[i];t.append(`<dt>${r.type}</dt>`);t.append(`<dd>${r.value}</dd>`)}}if(n.properties&&n.properties.length>0){const t=$("#properties");for(let i=0;i<n.properties.length;++i){const r=n.properties[i];t.append(`<dt>${r.key}</dt>`);t.append(`<dd>${r.value}</dd>`)}}},error:function(n){n.status===401&&(window.location.href="login.html?returnUrl=/diagnostics.html")}})}function initLoggedOut(){const n=getQueryParam("postLogoutRedirectUri"),i=getQueryParam("clientName"),t=getQueryParam("signOutIframeUrl"),r=getQueryParam("automaticRedirectAfterSignOut");n&&($("#clientName").text(i),$("#postLogoutRedirect").show(),r&&(window.location=n));t?($("#signOutIframe").show(),$("#signOutIframeUrl").attr("src",t)):window.location="/"}function initLogin(){$.validator.setDefaults({errorContainer:"div.error",errorLabelContainer:$("#form div.error"),wrapper:"label"});$("#loginButton").click(function(){const n=$("#message");n.hide();$("#form").validate({rules:{username:{required:!0},password:{required:!0}},messages:{username:{required:"用户名不能为空"},password:{required:"请输入密码"}},submitHandler:function(t){let i=getQueryParam("returnUrl");i=i?i:"";$.ajax({xhrFields:{withCredentials:!0},type:"POST",url:"account/login",data:$(t).serialize()+"&returnUrl="+encodeURIComponent(i),beforeSend:function(){},success:function(t){if(t.location){const i=t.location;let n=window;while(n!==n.top)n=n.top;n.location.href=i}else if(t.code!==200)if(n.show(),t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n==0?t:"<br/>"+t)}n.html(r)}else printError(t.code);else window.location.href="/"},error:function(){n.show();n.text("服务器出小差")}})}})})}function initChangePassword(){$.validator.setDefaults({errorContainer:"div.error",errorLabelContainer:$("#form div.error"),wrapper:"label"});$("#submitButton").click(function(){const n=$("#message");n.hide();$("#form").validate({rules:{username:{required:!0},password:{required:!0},oldPassword:{required:!0},confirmNewPassword:{required:!0}},messages:{username:{required:"用户名不能为空"},password:{required:"请输入密码"}},submitHandler:function(t){const i=$(t).serialize();$.ajax({xhrFields:{withCredentials:!0},type:"POST",url:"account/resetPassword2",data:i,success:function(t){if(t.code!==200)if(n.show(),t.message){const i=t.message.split("\n");let r="";for(let n=0;n<i.length;++n){const t=i[n];t&&(r+=n==0?t:"<br/>"+t)}n.html(r)}else printError(t.code);else window.location.href="/"},error:function(){n.show();n.text("服务器出小差")}})}})})}function initLogout(){const n=getQueryParam("logoutId");$("#logoutId").val(n)}function initSession(){$.get("session",n=>{if(n.data&&n.data.some(n=>n.type=="sub")){const i=$("#user");i.attr("sub",n.data.sub);let t=n.data.filter(n=>n.type=="name"),r="";t.length==0&&(t=n.data.filter(n=>n.type=="email"));r=t[0].value;i.prepend(r);$("#userNav").show()}})}function getQueryParam(n){const t=new URLSearchParams(window.location.search);return t.get(n)}$(document).ready(()=>{const n=location.href;n.indexOf("login.html")>=0?initLogin():n.indexOf("logout.html")>=0?initLogout():n.indexOf("loggedout.html")>=0?initLoggedOut():n.indexOf("diagnostics.html")>=0?(initSession(),initDiagnostics()):n.indexOf("consent.html")>=0?(initSession(),initConsent()):n.indexOf("redirect.html")>=0?initRedirect():n.indexOf("changePassword.html")>=0?initChangePassword():n.indexOf("error.html")>=0?(initSession(),initError()):initSession()});